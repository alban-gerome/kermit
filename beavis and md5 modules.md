Beavis.js and md5.js
====================
Updated 16 Apr 2017

Introduction:
-------------

MD5 is a one-way encryption algorithm which means that you can use this to encrypt anything you do not need to decrypt. For example a password can and probably should be encrypted and stored in encrypted format. If your database gets compromised by hacker they will have to decrypt the passwords. The downside is that as a user who forgot their password nobody can tell you what your password is. You can only have it reset to a temporary password and you get to pick a new one. MD5 hashes are also frequently provided with downloads. You calculate the MD5 hash of the download and compare it with the one provided by the source of that download. If the two hashes match you know that the download was not corrupted.

There are several one-way encryption or hashing algorithms available, some are available in Javascript, some not. MD5 has been ported to Javascript, it takes content of any length and generates a fixed length hexadecimal code of 32 characters. Kermit uses a MD5.js version I have found at http://www.myersdaily.org/joseph/javascript/md5.js. For this reason this a separate module.

The Beavis module generates unique identifiers and verification codes and requires the md5.js module. Here is a quick look at what you can use Beavis for:

* page views : Beavis will generate a temporary description for you while you figure out a naming convention
* interactions : Beavis generates a unique identifier for each interaction element already tagged with Kermit
* Kermit tags : Beavis generates a verification code which will change if the page body and/or the Kermit tags change


How to load beavis.js and md5.js?
-------------------------------------

Let's have a refresher on how to load a module in Kermit core:

    kermit.config.dependencies = [
      "../kermit/beavis.js",
      // other modules
    ]


Beavis and page views:
----------------------

If you want to track a page view using Kermit here's an example to refresh your memory:

    <div data-analytics-pageview-description="homepage"></div>

If you have a large number of pages you will need a naming convention which may lead to a lot of back and forth discussions between different stakeholders and take time. With Beavis you can get a temporary value for the page view description. Just change the code example above to this:

    <div data-analytics-pageview-description></div>

Now you can move on with this Kermit tagging project and when the naming convention has been agreed upon you can pass a page view description to your tags.

One thing to watch out for though is that if the contents of the HTML body change, even by as little as 1 character, the temporary page description will change. The web analytics tool might expect a page view description that no longer exists.


Beavis and interactions:
------------------------

Some heatmapping tools require a unique identifier for the elements you want to report on. Beavis will find all page elements tagged with a Kermit interaction description tag and give them a unique identifier.

The child nodes of the element can change, for example the text copy of a link can change but the identifier generated by Beavis will not change. IF the rest of the HTML changes though, a paragraph was added for example the Beavis identifier may change. This is because Beavis generates that identifier from the CSS selector of the element. If the CSS selector for an element changes the unique identifier generated by Beavis will also change.


Beavis and verification codes:
------------------------------

A common cause of frustration with web developers is sudden losses of analytics reporting. The developers have made changes, they did not thing that the analytics code would be impacted so the analytics team was not informed of these impending changes. The testers also found no Javascript errors so nobody thought that analytics would stop collecting data for one or more reports. We need somthing that will throw at least a warning when the HTML and/or the analytics tag have changed. Kermit core already provides handy function to see all Kermit tags at a glance:

* kermit.utils.getSummary : this will return a Javascript array of all HTML elements with Kermit tags
* kermit.utils.getAttributes : this will return a JSON object with all the Kermit data for a given HTML element

Beavis will generate a verification code of checksum which will change when:

* the Kermit tags have been modified
* the HTML body has been modified

You can add a test in your test suite to check the current verification code generated by the page against the expected verification code. If both do not match the test suite should thrown a warning or an error asking to verify the Kermit tags. Unfotunately if your developers have removed Kermit core or the Beavis module you will not have any verification code to compare against.


Additions to Kermit core:
-------------------------

Beavis introduce this new HTML5 _data-_ attributes automatically:

* data-analytics-interaction-id

Beavis will also add a property in your pageviews and interactions JSON objects:

* pageViewAttributes._checksum_


Beavis.js and md5.js properties:
--------------------------------

* kermit.utils.getMD5 : pass a string and get the MD5 hash
* kermit.utils.getSelector : pass a DOM element and get the CSS selector back
* kermit.utils.getCheckSum : calculate the verification code for the visible elements in the HTML body


Added in Beavis v0.2:
---------------------

* kermit.utils.getOuterMD5 : this will take a DOM element as input and calculate the MD5 hash of the document body inner HTML if the element was missing

_kermit.utils.getOuterMD5_ is used by 

* _pageViewAttributes.description_ when no page description was passed
* _pageViewAttributes.checksum_

The MD5 algorithm can sometimes generate the same hash for two different strings. This is called _hash collision_. With Beavis this means that:

* 2 or more page views share the same description or
* 2 or more interactions share the same description

Hash collisions are rare so before looking into whether you have a collision issue I would check whether a more basic implementation error is the root cause of the implementation issues you may have first. Once you have ruled out these a hash collision may have happened so what should you do?

_Beavis has generated the same page description for 2 pages, bad Beavis! Just give a proper name to these pages using_ data-analytics-pageview-description_. Sorted!_

Beavis has generated the same interaction description id for 2 DOM elements. Run a breakdown report of the interaction ids by the page descriptions, count how many page descriptions you have for any given interaction id. If that count is greater than 1 for one or more interaction ids you have a hash collision or a couple of them. Beavis v0.2 introduces a new Kermit tag:

* data-analytics-interaction-dedupe

Example

<pre><code>
data-analytics-interaction-dedupe="version 1"

</code></pre>


Alban Gérôme
16 Apr 2017

Follow me on Twitter: @albangerome
